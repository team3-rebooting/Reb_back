<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="adminCourseRequest">
	<select id="selectAll" resultType="AdminCourseRequestListDTO">
	<![CDATA[
		SELECT * FROM (
    		SELECT ROWNUM AS rnum, subquery.* FROM (
        	SELECT cr.course_number, m.member_number, m.member_id, m.member_name, c.COURSE_TITLE,TO_CHAR(c.COURSE_START_DATE, 'YYYY-MM-DD') AS COURSE_START_DATE,
            TO_CHAR(c.COURSE_END_DATE, 'YYYY-MM-DD') AS COURSE_END_DATE,cr.COURSE_REQUEST_TYPE_number 
        	FROM TBL_COURSE_request cr
        	JOIN TBL_COURSE c
        	ON cr.COURSE_NUMBER = c.COURSE_NUMBER
        	JOIN TBL_EXPERT e
    		ON c.EXPERT_NUMBER = e.EXPERT_NUMBER
			JOIN TBL_MEMBER m
    		ON e.MEMBER_NUMBER = m.MEMBER_NUMBER
    		where cr.course_open_status_number = 1 
            ORDER BY c.COURSE_START_DATE  
    	) subquery
	)
	WHERE rnum BETWEEN #{startRow} AND #{endRow}
		
	]]>
	</select>

	<select id="getTotal" resultType="int">
		SELECT COUNT(course_number)
		FROM tbl_course_request	
	</select> 
	<select id="select" parameterType="int" resultType="AdminCourseRequestDTO">
	<![CDATA[
	 SELECT 
    cr.COURSE_OPEN_STATUS_NUMBER, cr.COURSE_REQUEST_TYPE_NUMBER,
    TO_CHAR(cr.COURSE_REGISTER_DATE, 'YYYY-MM-DD') AS COURSE_REGISTER_DATE, 
    TO_CHAR(cr.COURSE_REQUEST_DATE, 'YYYY-MM-DD') AS COURSE_REQUEST_DATE, 
    TO_CHAR(cr.COURSE_RESULT_DATE, 'YYYY-MM-DD') AS COURSE_RESULT_DATE,
    cr.COURSE_REJECT_REASON,
    c.COURSE_NUMBER, c.COURSE_TITLE, c.COURSE_CONTENT,
    c.EXPERT_NUMBER, m.member_name, e.expert_license_info, e.expert_career, e.expert_field_number,
    c.COURSE_RECRUIT_STATUS_NUMBER,
    (select count(*) from tbl_course_member_applicant cma where
    cma.course_number = c.course_number) AS course_count, 
    TO_CHAR(c.COURSE_POST_DATE, 'YYYY-MM-DD') AS COURSE_POST_DATE, 
    TO_CHAR(c.COURSE_POST_UPDATE_DATE, 'YYYY-MM-DD') AS COURSE_POST_UPDATE_DATE,
    TO_CHAR(c.COURSE_RECRUIT_START_DATE, 'YYYY-MM-DD') AS COURSE_RECRUIT_START_DATE, 
    TO_CHAR(c.COURSE_RECRUIT_END_DATE, 'YYYY-MM-DD') AS COURSE_RECRUIT_END_DATE,
    TO_CHAR(c.COURSE_START_DATE, 'YYYY-MM-DD') AS COURSE_START_DATE, 
    TO_CHAR(c.COURSE_END_DATE, 'YYYY-MM-DD') AS COURSE_END_DATE,
    TO_CHAR(c.COURSE_START_TIME, 'HH24:MI') AS COURSE_START_TIME, 
    TO_CHAR(c.COURSE_END_TIME, 'HH24:MI') AS COURSE_END_TIME,
    c.COURSE_DAY_OF_WEEK, c.COURSE_RECRUIT_COUNT, cr.PREV_COURSE_NUMBER 
	FROM TBL_COURSE_REQUEST cr
	JOIN TBL_COURSE c
    ON cr.COURSE_NUMBER = c.COURSE_NUMBER
    JOIN tbl_expert e
    ON e.expert_number = c.expert_number
    JOIN tbl_member m
    ON e.member_number = m.MEMBER_number 
    where cr.COURSE_NUMBER = #{courseNumber}
	]]>
	</select>
	<!-- 여기 update 문 status number 다시 한번 확인  -->
	<!-- 신청 승인 -->
	<update id="approve" parameterType="int">
		update tbl_course_request set COURSE_OPEN_STATUS_NUMBER = 2, 
		COURSE_RESULT_DATE = to_date(sysdate, 'YYYY-MM-DD')
		where course_number = #{courseNumber}
	</update>
	<!-- 수정 승인 -->
	<update id="update" parameterType="int">
		update tbl_course_request set COURSE_OPEN_STATUS_NUMBER = 2, 
		COURSE_RESULT_DATE = to_date(sysdate, 'YYYY-MM-DD'),
		prev_course_number = '' 
		where course_number = #{courseNumber}
	</update>
	<!-- 삭제 승인  -->
	<delete id="deleteApprove" parameterType="int">
		delete from tbl_course_request where course_number = #{courseNumber}
	</delete>
	<!-- 반려 사유  -->
	<update id="rejection" parameterType="AdminCourseRequestDTO">
		update tbl_course_request set COURSE_OPEN_STATUS_NUMBER = 3, 
		COURSE_RESULT_DATE = to_date(sysdate, 'YYYY-MM-DD'),
		course_reject_reason = #{courseRejectReason}
		where course_number = #{courseNumber}
	</update>
	<!-- 이전 번호 가져오기 -->
	<select id="selectPrev" parameterType="int" resultType="int">
		select prev_course_number from tbl_course_request where course_number = #{courseNumber}
	</select>
	<insert id="insert" parameterType="CourseRequestDTO">
		INSERT INTO TBL_COURSE_REQUEST(COURSE_NUMBER, COURSE_OPEN_STATUS_NUMBER, COURSE_REQUEST_TYPE_NUMBER, COURSE_REGISTER_DATE, COURSE_REQUEST_DATE, COURSE_RESULT_DATE, COURSE_REJECT_REASON)
		values(#{courseNumber}, 3, #{courseRequestTypeNumber}, TO_DATE(#{courseRegisterDate}, 'YYYY-MM-DD'), sysdate, TO_DATE(#{courseResultDate}, 'YYYY-MM-DD'), #{courseRejectReason})
	</insert>
	<delete id="deleteRequest" parameterType="int">
		delete from tbl_course_request where course_number = #{courseNumber}
	</delete>
</mapper>
